#!/usr/bin/env bash
#!/usr/bin/env bash
# Pre-push hook: block direct pushes to main and run test suite.
set -euo pipefail

blocked=0
to_main=0
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$remote_ref" == "refs/heads/main" ]]; then
    to_main=1
  fi
done

# Guard: prevent direct pushes to main. Use PRs instead.
if [[ $to_main -eq 1 && "${ALLOW_MAIN_PUSH:-0}" != "1" ]]; then
  echo "[pre-push] Direct pushes to 'main' are blocked. Create a PR instead." >&2
  exit 1
fi

# Run tests before allowing push (can be skipped with HOOK_SKIP_TESTS=1)
if [[ "${HOOK_SKIP_TESTS:-0}" != "1" ]]; then
  echo "[pre-push] make test"
  make test
fi

exit 0
