#!/usr/bin/env bash
# Guard: prevent direct pushes to main. Use PRs instead.
set -euo pipefail

# Allow override (e.g., CI or emergency): export ALLOW_MAIN_PUSH=1
if [[ "${ALLOW_MAIN_PUSH:-0}" == "1" ]]; then
  exit 0
fi

blocked=0
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$remote_ref" == "refs/heads/main" ]]; then
    echo "[pre-push] Direct pushes to 'main' are blocked. Create a PR instead." >&2
    blocked=1
  fi
done

if [[ $blocked -eq 1 ]]; then
  exit 1
fi

exit 0
